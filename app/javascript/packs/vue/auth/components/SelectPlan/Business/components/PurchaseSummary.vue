<template lang="pug">
  .card.purchase-summary
    .card-header.purchase-summary-header
      | Purchase Summary
    .card-body.purchase-summary-body.p-y-20
      Coupon(@couponApplied="addDiscount")
    .card-body.purchase-summary-body.borderless.p-40.pb-0
      dl.row.mb-0
        dt.col-6 {{ planComputed.name }} plan
        dd.col-6.text-right.font-weight-bold {{ billingTypeSelected === 'annually' ?  planComputed.coastAnnuallyFormatted : planComputed.coastMonthlyFormatted }}
      dl.row.mb-0
        .col-6 {{ additionalUsers }} Users ({{ planComputed.usersCount }} Free)
        //dd.col-6.text-right.font-weight-bold {{ planComputed.additionalUserCoast !== '+$0' ? planComputed.additionalUserCoast : 'FREE' }}
        dd.col-6.text-right.font-weight-bold {{ planComputed.additionalUserCoast }}
      dl.row.mb-0
        .col-6.text-success(v-if="billingTypeSelected === 'annually' && planComputed.id !== 1") Billed Annually
        dd.col-6.text-right.text-success(v-if="billingTypeSelected === 'annually' && planComputed.id !== 1") You saved {{ planComputed.saved }}
      dl.row.mb-0(v-if="percent_off || amount_off")
        .col-6.text-success Discount
        dd.col-6.text-right.text-success(v-if="percent_off") {{ percent_off }}%
        dd.col-6.text-right.text-success(v-if="amount_off") ${{ amount_off }}
      //.card-body.purchase-summary-body.p-x-40.p-y-20(v-if="planComputed.tax")
      //  dl.row.mb-0
      //    dt.col-6
      //      b Tax
      //    dd.col-6.text-right.m-b-0
      //      b {{ planComputed.tax }}
      hr
      dl.row.mb-0.purchase-summary__total
        dt.col-6
          b Total
        dd.col-6.text-right.m-b-0
          b {{ planComputed.total }}
    .card-footer.purchase-summary-footer.borderless.p-40
      b-button.purchase-summary__btn(type='button' variant='dark' @click="complitePurchase" :disabled="disabled")
        // b-icon.mr-2(icon="arrow-clockwise" animation="spin" font-scale="1" v-show="loading")
        .lds-ring.lds-ring-small(v-show="loading")
          div
          div
          div
          div
        span(v-show="!loading") Complete Purchase
</template>

<script>
  import Coupon from '@/auth/components/Coupon'
  export default {
    props: ['billingTypeSelected', 'billingTypeOptions', 'plan', 'additionalUsers', 'disabled'],
    components: { Coupon },
    data() {
      return {
        loading: false,
        percent_off: 0,
        amount_off: null,
        coupon_id: ''
      }
    },
    methods: {
      calcAdditionalUserCoast(planType, usersCount, usersFreeCount, usersCoastMonthly, usersCoastAnnually) {
        let finalCoast;
        if (usersCount <= usersFreeCount) return `+$0`
        if (planType === 'monthly') {
          finalCoast = (usersCount-usersFreeCount) * usersCoastMonthly
        }
        if (planType === 'annually') {
          finalCoast = (usersCount-usersFreeCount) * usersCoastAnnually
        }
        return finalCoast !== 'FREE0' ? `+$${finalCoast}` : 'FREE'
      },
      countTotalCoast(planType, coastMonthly, coastAnnually, usersCount, usersFreeCount, usersCoastMonthly, usersCoastAnnually) {
        let finalCoast, finalUserCoast = 0;
        let percent_off = this.percent_off
        let amount_off = this.amount_off
        if (planType === 'monthly') {
          if (usersCount > usersFreeCount) finalUserCoast = (usersCount-usersFreeCount) * usersCoastMonthly
          finalCoast = coastMonthly + finalUserCoast
        }
        if (planType === 'annually') {
          if (usersCount > usersFreeCount)  finalUserCoast = (usersCount-usersFreeCount) * usersCoastAnnually
          finalCoast = coastAnnually + finalUserCoast
        }
        // CACL IF added percent_off
        if (percent_off && finalCoast !== 'FREE0') finalCoast = (finalCoast - (finalCoast / 100 * percent_off)).toFixed(2)
        if (amount_off && finalCoast !== 'FREE0') finalCoast = (finalCoast - amount_off).toFixed(2)
        return finalCoast !== 'FREE0' ? `+$${finalCoast}` : 'FREE'
      },
      complitePurchase() {
        const value = this.planComputed
        if (this.coupon_id) value.coupon_id = this.coupon_id
        this.$emit('complitePurchaseConfirmed', value)
      },
      addDiscount(value) {
        this.coupon_id = value.coupon_id
        this.percent_off = value.percent_off
        this.amount_off = value.amount_off / 100
      }
    },
    computed: {
      // loading() {
      //   return this.$store.getters.loading;
      // },
      planComputed() {
        return {
          ...this.plan,
          additionalUserCoast: this.calcAdditionalUserCoast(this.billingTypeSelected, this.additionalUsers, this.plan.usersCount, this.plan.additionalUserMonthly, this.plan.additionalUserAnnually),
          saved: `$${Math.abs(this.plan.coastAnnually - this.plan.coastMonthly * 12)}`,
          // tax: '$0.00',
          total: this.countTotalCoast(this.billingTypeSelected, this.plan.coastMonthly, this.plan.coastAnnually, this.additionalUsers, this.plan.usersCount, this.plan.additionalUserMonthly, this.plan.additionalUserAnnually),
        }
      },
    },
  }
</script>
