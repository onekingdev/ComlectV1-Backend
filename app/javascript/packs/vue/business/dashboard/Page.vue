<template lang="pug">
  .page
    Get(currentBusiness="/api/businesses/current"): template(v-slot="{ currentBusiness }")
      .page-header
        h2.page-header__title
          b Welcome,&nbsp;
          | {{currentBusiness.business_name}}
        .page-header__actions
          b-dropdown.mr-2(variant="default" right)
            template(#button-content)
              | Admin view
              b-icon.ml-2(icon="chevron-down")
            b-dropdown-item Other view
          a.btn.btn-default.font-weight-bold Customize
      div.p-x-40
        .row
          //.col-md-7.col-sm-12.mb-3.mb-md-0
          .col-7
            .card
              Calendar(v-bind="{pdfUrl}" @saved="newEtag" :etag="etag")
          //.col-md-5.col-sm-12
          .col-5
            .card.h-100
              UpcomingTasks(@saved="newEtag" :etag="etag")
</template>

<script>
import Calendar from './Calendar'
import UpcomingTasks from '@/business/dashboard/UpcomingTasks'

const endpointProjectsUrl = '/api/business/local_projects/'
const pdfUrl = '/business/reminders.pdf'

export default {
  data() {
    return {
      etag: Math.random(),
      projects: []
    }
  },
  methods: {
    newEtag() {
      this.etag = Math.random()
    },
    refetch() {
      fetch(endpointProjectsUrl, { headers: {'Accept': 'application/json'} })
        .then(response => response.json())
        .then(result => this.projects = result)
    }
  },
  created() {
    this.refetch()

    const firstView = JSON.parse(localStorage.getItem('app.currentUser.firstEnter'))
    if (firstView) {
      this.toast('Success', 'Account has been created.')
      localStorage.removeItem('app.currentUser.firstEnter')
    }
  },
  computed: {
    pdfUrl: () => pdfUrl
  },
  components: {
    Calendar,
    UpcomingTasks,
  }
}
</script>
