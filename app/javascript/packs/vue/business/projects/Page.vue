<template lang="pug">
  .page
    .page-header
      .page-header__title
        h2.m-b-10 Projects
        p.page-header__subtitle.mb-0 Plan projects with employees or hire external specialists to help
      .page-header__actions.mt-0.mb-auto
        router-link.btn.btn-default.m-r-1(v-if="role !=='basic'" to='/business/projects/new') Post Project
        LocalProjectModal(@saved="newEtag")
          a.btn.btn-primary New Project
    b-tabs.special-navs(content-class="mt-0 h-100")
      b-tab(title="My Projects" active)
        .card-body.white-card-body.card-body_full-height
          div.m-b-20
            b-dropdown.m-r-1(variant="default")
              template(#button-content)
                | Filter by: {{filteredStatus}}
                ion-icon.ml-2(name="chevron-down-outline" size="small")
              b-dropdown-item(v-for="(status, key) in filterStatuses" :key="key" @click="filterStatus = key") {{status}}
            //b-dropdown.m-r-1(variant="default")
            //  template(#button-content)
            //    | Year: All
            //    ion-icon.ml-2(name="chevron-down-outline" size="small")
            //  b-dropdown-item 2021
            //  b-dropdown-item 2020
          Get(projects="/api/local_projects/" :etag="etag"): template(v-slot="{projects}")
            ProjectTable(:projects="filterProjects(projects)")
      b-tab(title="Contacts")
        .card-body.white-card-body.card-body_full-height
          Get(contacts="/api/local_projects/" :etag="etag" :callback="getContacts"): template(v-slot="{contacts}"): div
            table.table
              thead
                tr
                  th Name
                    b-icon.ml-2(icon='chevron-expand')
                  th Location
                    b-icon.ml-2(icon='chevron-expand')
                  th Status
                    b-icon.ml-2(icon='chevron-expand')
                  th(width="140px") Rating
                    b-icon.ml-2(icon='chevron-expand')
                  th(width="40px")
              tbody
                tr(v-for="contact in contacts" :key="contact.id")
                  td {{ contact.name }}
                  td {{ contact.location }}
                  td: .badge.badge-success {{ contact.status }}
                  //td: StarRating(:stars="contact.rating")
                  //td &hellip;
                  td.text-right
                    .d-flex.justify-content-end
                      StarsRating(:rate="contact.rating")
                  td(width="40px").text-right
                    b-dropdown(size="xs" variant="none" class="m-0 p-0" right)
                      template(#button-content)
                        b-icon(icon="three-dots")
                      b-dropdown-item Message
                      b-dropdown-item Remove Contact
            .row.h-100(v-if="contacts && !contacts.length && !loading")
              .col.h-100.text-center
                EmptyState(name="Tasks")
      b-tab.h-100(title="Ratings and Reviews")
        .card-body.white-card-body.card-body_full-height.h-100
          Get.h-100(ratings='/api/project_ratings'): template(v-slot="{ratings}")
            table.rating_table(v-if="ratings.length")
              tbody
                tr(v-for="rating in ratings")
                  td
                    img.m-r-1.userpic_small(v-bind:src="rating.rater_pic")
                  td
                    h3 {{rating.project_title}}
                    p {{rating.rater_name}} | {{rating.created_at | asDate}}
                    p: i "{{rating.review}}"
                  td: StarRating(:stars="rating.value")
                //tr(v-if="!ratings.length")
                //  td.text-center
                //    h3.text-dark.p-y-2 No ratings
            .d-flex.flex-grow-1.justify-content-center.align-items-cener.h-100(v-if="!ratings.length")
              EmptyState(name="Tasks")
</template>

<script>
import { mapGetters } from "vuex"
import EmptyState from '@/common/EmptyState'
import ProjectTable from './ProjectTable'
import LocalProjectModal from './LocalProjectModal'
import EtaggerMixin from '@/mixins/EtaggerMixin'
import StarsRating from '@/business/marketplace/components/StarsRating'

const FILTER_STATUSES = {
  all: 'All',
  not_started: 'Not Started',
  draft: 'Draft',
  in_progres: 'In Progress',
  pending: 'Pending',
  complete: 'Complete',
  overdue: 'Overdue'
}

export default {
  mixins: [EtaggerMixin()],
  data() {
    return {
      filterStatus: Object.keys(FILTER_STATUSES)[0]
    }
  },
  components: {
    ProjectTable,
    LocalProjectModal,
    StarsRating,
    EmptyState
  },
  methods: {
    getContacts(projects) {
      return projects.reduce((result, project) => {
        for (const p in project.projects) {
          const spec = project.projects[p].specialist
          if (spec && !result.find(s => s.id === spec.id)) {
            result.push({
              id: spec.id,
              name: spec.first_name + ' ' + spec.last_name,
              // location: [spec.country, spec.state, spec.city].filter(a => a).join(', '),
              location: spec.location,
              status: spec.visibility === 'is_public' ? 'Available' : 'Unavailable',
              rating: 5
            })
          }
        }
        return result
      }, [])
    },
    filterProjects(projects) {
      return projects.filter(project => ['all', project.status_business].includes(this.filterStatus))
    }
  },
  computed: {
    ...mapGetters({
      roles: 'roles/roles',
      role: 'roles/currentRole',
      plan: 'roles/currentPlan',
    }),
    filterStatuses: () => FILTER_STATUSES,
    filteredStatus() {
      return FILTER_STATUSES[this.filterStatus]
    }
  }
}
</script>
