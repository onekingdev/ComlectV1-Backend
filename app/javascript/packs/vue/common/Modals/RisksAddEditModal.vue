<template lang="pug">
  div(:class="{'d-inline-block':inline}")
    div(v-b-modal="modalId" :class="{'d-inline-block':inline}")
      slot

    b-modal.fade(:id="modalId" :title="riskId ? 'Edit risk' : 'New risk'" @close="hideModal" @show="newEtag")
      ModelLoader(:url="riskId ? submitUrl : undefined" :default="initialrisk" :etag="etag" @loaded="loadrisk")

        b-form-group#input-group-1.form-label.mb-3(v-if="showRiskOption" label='Risk' label-for='select-1')
          b-form-select#select-1(v-model='risk.risks' :options='options' @change="onChange" required)
          Errors(:errors="errors.risk")

        b-row(no-gutters)
          .col
            label.form-label Risk Name
            input.form-control(v-model="risk.name" type=text)
            Errors(:errors="errors.name")

        b-row.m-t-1(no-gutters)
          .col-sm.m-r-1
            b-form-group#input-group-2.form-label(label='Impact' label-for='select-2')
              b-form-select#select-2(v-model="risk.impact" :errors="errors.impact" :options="levelOptions" @change="onRiskChange")
              Errors(:errors="errors.impact")
          .col-sm
            b-form-group#input-group-3.form-label(label='Likelihood' label-for='select-3')
              b-form-select#select-3(v-model="risk.likelihood" :errors="errors.likelihood" :options="levelOptions" @change="onRiskChange")
              Errors(:errors="errors.likelihood")

        b-row.mt-2(no-gutters)
          .col
            label.form-label Risk Level
            div
              b-icon.mr-3(icon="exclamation-triangle-fill" scale="1" :variant="badgeVariant")
              | {{ riskLevelName }}

      template(slot="modal-footer")
        button.btn.btn-link(@click="hideModal()") Cancel
        button.btn.btn-dark(@click="submit") {{ riskId ? 'Save' : 'Add' }}
</template>

<script>
import EtaggerMixin from '@/mixins/EtaggerMixin'

const rnd = () => Math.random().toFixed(10).toString().replace('.', '')

const initialrisk = () => ({
  name: "",
  id: null,
  impact: 0,
  likelihood: 0,
  compliance_policies: [],
  compliance_policy_ids: []
})

export default {
  mixins: [EtaggerMixin()],
  props: {
    id: String,
    risks: Array,
    riskId: Number,
    remindAt: String,
    inline: {
      type: Boolean,
      default: true
    },
    risksList: Array,
    policyId: Number,
    showRiskOption: {
      type: Boolean,
      default: false,
    }
  },
  data() {
    return {
      modalId: this.id || `modal_${rnd()}`,
      risk: initialrisk(),
      isActive: false,
      options: [
        { value: null, text: 'New Risk' },
      ],
      levelOptions: [
        { value: 0, text: 'Low' },
        { value: 1, text: 'Medium' },
        { value: 2, text: 'High' },
      ],
      badgeVariant: 'secondary',
      riskLevelName: '---',
      errors: {},
    }
  },
  methods: {
    hideModal() {
      this.errors = {}
      this.$bvModal.hide(this.modalId)
    },
    loadrisk(risk) {
      this.risk = Object.assign({}, this.risk, risk)
      this.onRiskChange()

      this.options = [{ value: null, text: 'New Risk' }]
      this.options = this.options.concat(this.risksComputedAsOptions)
    },
    submit(e) {
      e.preventDefault()
      this.errors = {}
      if (!this.risk.name) {
        this.$set(this.errors, 'name', ['Required field'])
        return
      }

      this.risk.compliance_policy_ids = this.risk.compliance_policies.map(policy => policy.id)
      if (!this.risk.compliance_policy_ids.includes(this.policyId)) this.risk.compliance_policy_ids.push(this.policyId)

      let method;
      if(!this.riskId && !this.risk.id) {
        method = 'createRisk'
      } else {
        method = 'updateRisk'
      }

      this.$store
        .dispatch(method, {...this.risk})
        .then(response => {
          if (response.errors) {
            const text = method === 'createRisk' ? 'Risk has not been created. Please try again.' : 'Risk has not been updated. Please try again.'
            this.toast('Error', text)
          } else {
            if (method == 'createRisk') {
              this.toast('Success', 'Risk has been created.')
            } else {
              this.toast('Success', 'Risk has been updated.')
            }
            this.$emit('saved', response)
            this.$bvModal.hide(this.modalId)
            this.newEtag()
          }
        })
        .catch(error => {
          console.error(error)
          this.toast('Error', `Risk has not been created. Please try again. ${error}`, true)
        })
    },
    onChange(event){
      // CATCH RISK NEW OR FROM CREATED
      if (event === null) {
        this.isActive = true
        this.risk = initialrisk()
        this.badgeVariant = 'secondary'
        this.riskLevelName = '---'
        return;
      }
      else  {
        this.isActive = false
      }

      const resultRisk = this.risks.find(risk => risk.id === event)
      this.risk = resultRisk
      this.onRiskChange()
    },
    onRiskChange(){
      const riskLevelNum = this.riskLevel(this.risk.likelihood, this.risk.impact)
      this.riskLevelColor(riskLevelNum)
      this.getRiskLevelName(riskLevelNum)
    },
    getRiskLevelName(num) {
      this.riskLevelName = this.levelOptions[num].text
    },
    riskLevel(likelihood, impact) {
      if ((likelihood > 0) && (impact === 2)) {
        return 2;
      } else if ((likelihood < 2) && (impact === 0)) {
        return 0;
      } else {
        return 1;
      }
    },
    riskLevelColor(num) {
      if (num === 0) this.badgeVariant = 'success'
      if (num === 1) this.badgeVariant = 'warning'
      if (num === 2) this.badgeVariant = 'danger'
    },
  },
  computed: {
    initialrisk: () => initialrisk,
    canBeDraft() {
      return !this.riskId || ('draft' === this.risk.status)
    },
    submitUrl() {
      const toId = this.riskId ? `/${this.riskId}` : ''
      return '/api/business/risks' + toId
    },
    httpMethod() {
      return this.riskId ? 'PUT' : 'POST'
    },
    risksComputedAsOptions() {
      return this.risks.map(risk => {
        return {
          value: risk.id, text: risk.name
        }
      })
    }
  },
  watch: {}
}
</script>
